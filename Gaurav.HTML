<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hand Gesture 3D Particles | Gaurav Shrestha</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        
        /* UI Overlay */
        #info { position: absolute; top: 20px; left: 20px; color: #0ff; text-shadow: 0 0 10px #0ff; pointer-events: none; z-index: 10; }
        #status { font-size: 14px; color: #fff; margin-top: 10px; opacity: 0.8; }
        
        /* Credits Watermark */
        #credits { 
            position: absolute; 
            bottom: 20px; 
            left: 20px; 
            color: rgba(255, 255, 255, 0.7); 
            letter-spacing: 2px;
            font-size: 12px;
            text-transform: uppercase;
            border-left: 2px solid #0ff;
            padding-left: 10px;
        }
        #credits span { color: #0ff; font-weight: bold; display: block; font-size: 16px; margin-top: 4px; }

        canvas#webcam { position: absolute; bottom: 20px; right: 20px; width: 240px; height: 180px; border: 2px solid #333; transform: scaleX(-1); border-radius: 12px; }
        .hint { color: #ff00ff; font-weight: bold; }
    </style>
</head>
<body>

<div id="info">
    <h1>Particle Orchestrator</h1>
    <div>• Open/Close Hand: <span class="hint">Expand/Contract</span></div>
    <div>• Pinch Thumb + Index: <span class="hint">Change Colors</span></div>
    <div>• Hold Peace Sign (✌️): <span class="hint">Next Template</span></div>
    <div id="status">Warming up AI models...</div>
</div>

<!-- Credit to Gaurav Shrestha -->
<div id="credits">
    3D Animation & Engineering by
    <span>GAURAV SHRESTHA</span>
</div>

<video id="video" style="display:none;" autoplay playsinline></video>
<canvas id="webcam"></canvas>

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js"
        }
    }
</script>

<script type="module">
    import * as THREE from 'three';
    import { HandLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0";

    console.log("%c 3D Animation by Gaurav Shrestha ", "background: #000; color: #0ff; font-weight: bold; padding: 5px;");

    const PARTICLE_COUNT = 10000;
    let handLandmarker;
    let lastVideoTime = -1;
    let currentShapeIndex = 0;
    let colorHue = 0.5;
    let expansionFactor = 1.0;
    let gestureCooldown = false;

    // --- Scene Setup ---
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 8;

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    document.body.appendChild(renderer.domElement);

    const geo = new THREE.BufferGeometry();
    const posArray = new Float32Array(PARTICLE_COUNT * 3);
    const targetArray = new Float32Array(PARTICLE_COUNT * 3);
    const colorArray = new Float32Array(PARTICLE_COUNT * 3);

    for (let i = 0; i < PARTICLE_COUNT * 3; i++) {
        posArray[i] = (Math.random() - 0.5) * 20;
    }

    geo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
    geo.setAttribute('color', new THREE.BufferAttribute(colorArray, 3));

    const mat = new THREE.PointsMaterial({
        size: 0.04,
        vertexColors: true,
        transparent: true,
        opacity: 0.8,
        blending: THREE.AdditiveBlending
    });

    const points = new THREE.Points(geo, mat);
    scene.add(points);

    // --- Shape Templates ---
    function updateTargets(shapeType) {
        for (let i = 0; i < PARTICLE_COUNT; i++) {
            const i3 = i * 3;
            let x, y, z;
            const t = (i / PARTICLE_COUNT) * Math.PI * 2;

            if (shapeType === 0) { // Heart
                const hT = Math.random() * Math.PI * 2;
                x = 16 * Math.pow(Math.sin(hT), 3);
                y = 13 * Math.cos(hT) - 5 * Math.cos(2*hT) - 2 * Math.cos(3*hT) - Math.cos(4*hT);
                z = (Math.random() - 0.5) * 2;
                x *= 0.25; y *= 0.25;
            } else if (shapeType === 1) { // Saturn
                if (i < PARTICLE_COUNT * 0.4) {
                    const phi = Math.acos(-1 + (2 * i) / (PARTICLE_COUNT * 0.4));
                    const theta = Math.sqrt(PARTICLE_COUNT * 0.4 * Math.PI) * phi;
                    x = Math.cos(theta) * Math.sin(phi) * 2.5;
                    y = Math.sin(theta) * Math.sin(phi) * 2.5;
                    z = Math.cos(phi) * 2.5;
                } else {
                    const r = 3.5 + Math.random() * 2.0;
                    const ang = Math.random() * Math.PI * 2;
                    x = Math.cos(ang) * r;
                    y = Math.sin(ang) * r * 0.2;
                    z = Math.sin(ang) * r;
                }
            } else if (shapeType === 2) { // Flower
                const fR = 4 * Math.cos(6 * t);
                x = fR * Math.cos(t);
                y = fR * Math.sin(t);
                z = (Math.random() - 0.5) * 0.5;
            } else if (shapeType === 3) { // Face
                const p = Math.random();
                if (p > 0.4) { x = Math.cos(t) * 4; y = Math.sin(t) * 4.5; z = 0; }
                else if (p > 0.2) { x = (Math.random() > 0.5 ? 1 : -1) * 1.5; y = 1; z = 0.5; }
                else { x = Math.cos(Math.random() * Math.PI + Math.PI) * 2; y = -1.5; z = 0; }
            } else { // Fireworks
                const rad = 6 * Math.pow(Math.random(), 0.5);
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.random() * Math.PI;
                x = rad * Math.sin(phi) * Math.cos(theta);
                y = rad * Math.sin(phi) * Math.sin(theta);
                z = rad * Math.cos(phi);
            }
            targetArray[i3] = x;
            targetArray[i3+1] = y;
            targetArray[i3+2] = z;
        }
    }

    updateTargets(0);

    // --- MediaPipe Hand Tracking ---
    async function init() {
        const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
        handLandmarker = await HandLandmarker.createFromOptions(vision, {
            baseOptions: { modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`, delegate: "GPU" },
            runningMode: "VIDEO", numHands: 1
        });
        document.getElementById('status').innerText = "AI Ready. Interaction Live.";
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        const video = document.getElementById('video');
        video.srcObject = stream;
        video.addEventListener('loadeddata', predict);
    }

    async function predict() {
        const video = document.getElementById('video');
        if (lastVideoTime !== video.currentTime) {
            lastVideoTime = video.currentTime;
            const result = handLandmarker.detectForVideo(video, performance.now());
            if (result.landmarks && result.landmarks.length > 0) {
                const pts = result.landmarks[0];
                expansionFactor = THREE.MathUtils.lerp(expansionFactor, Math.hypot(pts[0].x - pts[12].x, pts[0].y - pts[12].y) * 4, 0.1);
                if (Math.hypot(pts[4].x - pts[8].x, pts[4].y - pts[8].y) < 0.05) colorHue = (colorHue + 0.01) % 1;
                
                const isPeace = pts[8].y < pts[6].y && pts[12].y < pts[10].y && pts[16].y > pts[14].y;
                if (isPeace && !gestureCooldown) {
                    currentShapeIndex = (currentShapeIndex + 1) % 5;
                    updateTargets(currentShapeIndex);
                    gestureCooldown = true;
                    setTimeout(() => gestureCooldown = false, 1000);
                }
                points.rotation.y = (pts[9].x - 0.5) * 2;
                points.rotation.x = (pts[9].y - 0.5) * 2;
            }
        }
        requestAnimationFrame(predict);
    }

    function animate() {
        const pos = geo.attributes.position.array;
        const col = geo.attributes.color.array;
        for (let i = 0; i < PARTICLE_COUNT; i++) {
            const i3 = i * 3;
            pos[i3] += (targetArray[i3] * expansionFactor - pos[i3]) * 0.08;
            pos[i3+1] += (targetArray[i3+1] * expansionFactor - pos[i3+1]) * 0.08;
            pos[i3+2] += (targetArray[i3+2] * expansionFactor - pos[i3+2]) * 0.08;
            const c = new THREE.Color().setHSL((colorHue + i/PARTICLE_COUNT) % 1, 0.8, 0.5);
            col[i3] = c.r; col[i3+1] = c.g; col[i3+2] = c.b;
        }
        geo.attributes.position.needsUpdate = true;
        geo.attributes.color.needsUpdate = true;
        renderer.render(scene, camera);
        requestAnimationFrame(animate);
    }

    init();
    animate();
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
</script>
</body>
</html>